###
# General Macros
#
[hr_duration(1)]
args = field
definition = rex field=$field$ "((?<days>\d+)\+)?(?<hours>\d+):(?<minutes>\d+):(?<seconds>\d+)" | eval $field$=coalesce(days,"0")+"d "+hours+"h "+minutes+"m "+seconds+"s" | fields - days,hours,minutes,seconds

[lsm_existing_indexes]
definition = eventcount summarize=false index=* | dedup index | fields index

[lsm_set_index_internal]
definition = index=_internal
iseval = 0

###
# Filters
#
[lsm_index_filter]
definition = index=*

[lsm_punct_index_filter]
definition = index=*

[lsm_excluded_sourcetypes]
definition = stash,csv,splunk_config,canary*,fs_notification

###
# Settings
#
[lsm_span]
definition = 1h

[lsm_missing_forwarder_time]
definition = 1m

[lsm_max_index_age]
definition = "1h"

###
# Lookup generators
#
[lsm_generate_existing_indexes]
definition = `lsm_existing_indexes` | eval exists = "true" | outputlookup lsm_existing_indexes

###
# Forwarders
#
[lsm_get_forwarder_tcpin]
definition = `lsm_set_index_internal` sourcetype=splunkd group=tcpin_connections (connectionType=cooked OR connectionType=cookedSSL) fwdType=* guid=*

[lsm_rename_forwarder_type(1)]
args = type
definition = eval $type$ = case($type$ == "full", "Heavy Forwarder", $type$ == "uf", "Universal Forwarder", $type$ == "lwf", "Light Forwarder", 1==1, $type$)

[lsm_eval_forwarder_status]
definition = eval Status = if(isnull(sum_kb) or (sum_kb <= 0) or (last_connected < (info_max_time - 900)), "missing", "active") | fields - sum_kb

[lsm_forwarder_overview]
definition = `lsm_forwarder_overview(1m)`

[lsm_forwarder_overview(1)]
args = earliest
definition = `lsm_get_forwarder_tcpin` hostname=* earliest=-$earliest$\
    | eval source_uri = hostname.":".sourcePort\
    | eval dest_uri = host.":".destPort\
    | eval connection = source_uri."->".dest_uri\
    | eval destination = "-> ".host\
    | stats latest(_time) as _time, values(fwdType) as fwdType, values(sourceIp) as sourceIp, latest(version) as version,  values(os) as os, values(arch) as arch, dc(dest_uri) as dest_count, dc(connection) as connection_count, avg(tcp_KBps) as avg_tcp_kbps, avg(tcp_eps) as avg_tcp_eps, values(destination) as Destinations, sum(kb) as sum_kb by hostname, guid\
    | eval avg_tcp_kbps = round(avg_tcp_kbps, 2)\
    | eval avg_tcp_eps = round(avg_tcp_eps, 2)\
    | `lsm_rename_forwarder_type(fwdType)`\
    | rename hostname as Instance, fwdType as "Forwarder Type", sourceIp as IP, version as "Splunk Version", os as OS, arch as Architecture, guid as GUID, dest_count as "Receiver Count", connection_count as "Connection Count", avg_tcp_kbps as "Average KB/s", avg_tcp_eps as "Average Events/s"\
    | inputlookup append=true lsm_forwarder_assets\
    | dedup GUID,Instance\
    | `lsm_eval_forwarder_status`\
    | outputlookup lsm_forwarder_assets\
    | reltime\
    | rename reltime AS "Last seen"\
    | table Instance, Destinations, GUID, "Forwarder Type", IP, "Splunk Version", OS, Architecture, "Average KB/s", "Average Events/s", "Receiver Count", "Connection Count", "Last seen", Status\
    | sort - Status

###
# Analysing
#
[lsm_analyse_common]
definition = fillnull value=0 events,avg_events,stdev_events\
    | fillnull value=1 lastTime\
    | eval latestTime = relative_time(now(), printf("-%s", maxAge))\
    | eval diff=abs(avg_events-events)\
    | eval prc=if(avg_events==0, "N/A", round(events/avg_events*100,2))\
    | eval status = case(lastTime < latestTime, "outage",\
           diff > maxStdDev*stdev_events AND avg_events > events, "underload",\
           diff > maxStdDev*stdev_events AND avg_events < events, "overload",\
           1==1, "ok")\
    | eval _time = lastTime\
    | reltime

[lsm_analyse_source(2)]
args = index,sourcetype
definition = tstats count AS events where earliest=-30d@h latest=-1h@h\
        index="$index$" sourcetype="$sourcetype$"\
        by _time,host,source span=1h\
        | stats avg(events) as avg_events stdev(events) as stdev_events by host,source\
        | sort host,source\
| lookup lsm_source_lookup host,source\
| fillnull value=2h maxAge\
| fillnull value=1 maxStdDev\
| join type=left host,source\
    [| tstats count AS events where earliest=-1h\
        index="$index$" sourcetype="$sourcetype$"\
        by _time,host,source span=1h\
        | stats sum(events) as events by host,source\
        | sort host,source]\
| join type=left host,source\
    [| tstats latest(_time) as lastTime where earliest=-30d@h latest=now\
        index="$index$" sourcetype="$sourcetype$"\
        by host,source\
        | sort host,source]\
| `lsm_analyse_common`\
| `lsm_format_monitor_table("host,source")`

[lsm_analyse(2)]
args = key1,key2
definition = inputlookup lsm_$key2$_lookup | where enabled = "true" | sort $key1$,$key2$\
| join type=left $key1$,$key2$\
    [| tstats count AS events where earliest=-1h `lsm_index_filter`\
        [| inputlookup lsm_$key2$_lookup | where enabled = "true" | fields $key1$,$key2$]\
        by _time,$key1$,$key2$ span=1h\
        | stats sum(events) as events by $key1$,$key2$\
        | sort $key1$,$key2$]\
| join type=left $key1$,$key2$\
    [| tstats count AS events where earliest=-30d@h latest=-1h@h `lsm_index_filter`\
        [| inputlookup lsm_$key2$_lookup | where enabled = "true" | fields $key1$,$key2$]\
        by _time,$key1$,$key2$ span=1h\
        | stats avg(events) as avg_events stdev(events) as stdev_events by $key1$,$key2$\
        | sort $key1$,$key2$]\
| join type=left $key1$,$key2$\
    [| tstats latest(_time) as lastTime where earliest=-30d@h latest=now `lsm_index_filter`\
        [| inputlookup lsm_$key2$_lookup | where enabled = "true" | fields $key1$,$key2$]\
        by $key1$,$key2$\
        | sort $key1$,$key2$]\
| `lsm_analyse_common`\
| `lsm_format_monitor_table($key1$","$key2$)`

[lsm_analyse_indexes]
definition = inputlookup lsm_index_lookup | where enabled = "true" | sort index\
| join type=left index\
    [| tstats sum(data.total_event_count) as events\
        where earliest=-1h index=_introspection host=idx sourcetype=splunk_disk_objects component=Indexes data.name!=_*\
        [| inputlookup lsm_index_lookup | where enabled = "true" | fields index | rename index AS data.name]\
        by _time,data.name span=1h\
        | rename data.name AS index\
        | stats sum(events) as events by index\
        | sort index]\
| join type=left index\
    [| tstats sum(data.total_event_count) as events\
        where earliest=-30d@h latest=-1h@h index=_introspection host=idx sourcetype=splunk_disk_objects component=Indexes data.name!=_*\
        [| inputlookup lsm_index_lookup | where enabled = "true" | fields index | rename index AS data.name]\
        by _time,data.name span=1h\
        | rename data.name AS index\
        | stats avg(events) as avg_events stdev(events) as stdev_events by index\
        | sort index]\
| join type=left index\
    [| dbinspect index=*\
        | search [| inputlookup lsm_index_lookup | where enabled = "true" | fields index]\
        | stats max(endEpoch) as lastTime by index\
        | sort index]\
| `lsm_analyse_common`\
| `lsm_format_monitor_table(index)`

###
# Output formatting
#
[lsm_apply_renames_monitor_table]
definition = rename host AS Host,\
    source AS Source,\
    index AS Index, sourcetype AS Sourcetype,\
    status AS Status,\
    reltime AS "Latest Event",\
    avg_events as "Avg Events",\
    events AS "Current Events",\
    stdev_events AS "STDev Events",\
    prc AS "%",\
    diff AS Diff

[lsm_format_monitor_table(1)]
args = keys
definition = eval avg_events=round(avg_events,0)\
    | eval events=round(events,0)\
    | eval stdev_events=round(stdev_events,0)\
    | eval diff=round(diff,0)\
    | table $keys$,status,reltime,avg_events,events,stdev_events,prc,diff\
    | `lsm_apply_renames_monitor_table`

#
# Useful?
#
[lsm_toggle_enabled(2)]
args = host, source
definition = inputlookup lsm_source_lookup | search host="$host$" source="$source$" | eval enabled=if(enabled=="false","true","false") | inputlookup append=t lsm_source_lookup | dedup host,source | outputlookup lsm_source_lookup

